<%- include('partials/_header') %>

    
    </head>

    <body>

        <!-- Navigation Bar-->
        <%- include('partials/_navigation')%>


        <% if(admin && ('role' in admin)){ %>

            <% if(status =='add'){ %>

                <%if(admin.role=='super'){%>
                    <div class="wrapper">
                        <div class="container-fluid">
            
                            <!-- Page-Title -->
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="page-title-box">
                                        <div class="btn-group pull-right">
                                            <ol class="breadcrumb hide-phone p-0 m-0">
                                                <li class="breadcrumb-item"><a href="#">Panel</a></li>
                                                <li class="breadcrumb-item"><a href="#">Ayarlar</a></li>
                                                <li class="breadcrumb-item active">API Ayarları</li>
                                            </ol>
                                        </div>
                                        <h4 class="page-title">API Ekle </h4>
                                    </div>
                                </div>
                            </div>
                            <!-- end page title end breadcrumb -->

                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <%if(admin.confirmation == true){%>

                                                <div class="row">
                                                    <div class="offset-1 col-md-10">
                                                        <div class="p-20">
                                                            
                                                            <h4 class="mt-0 header-title">API Bilgileri</h4>
                                                            <p class="text-muted mb-4 font-14">Lütfen API bilgilerini eksiksiz doldurunuz.</p>

                                                            <form method="post" action="/api/create">
                                                                <div class="row">
        
                                                                    <div class="col-md-12">
                                                                        <label>API Durumu</label>
                                                                        <select name="status"class="form-control">
                                                                            <option hidden>Select</option>
                                                                            <option value="true">Aktif</option>
                                                                            <option value="false">Pasif</option>
                                                                        </select>
                                                                    </div>

                                                                    <div class="col-md-6">
                                                                        <div class="form-group mb-0">
                                                                            <label class="my-2 py-1">İsim</label>
                                                                            <input type="text" name="name"  required class="form-control">
                                                                        </div>
                                                                    </div>
        
                                                                    <div class="col-md-6">
                                                                        <div class="form-group mb-0">
                                                                            <label class="my-2 py-1">E-Mail</label>
                                                                            <input type="email"   name="email" required  class="form-control">
                                                                        </div>
                                                                    </div>
        
        
                                                                    <input type="hidden"  name="select" value="false" >
                                                                </div>
        
                                                                <div style="text-align: center" class="form-group mb-0 mt-5">
                                                                    <div class="">
                                                                        <button type="submit" class="btn btn-primary waves-effect waves-light">
                                                                            Gönder
                                                                        </button>
                                                                        <button type="reset" class="btn btn-secondary waves-effect m-l-5">
                                                                            İptal
                                                                        </button>
                                                                    </div>
                                                                </div>
        
                                                            </form> 
                                                        
                                                        </div>
                                                    </div> <!-- end col -->
                                                    
                                                </div> <!-- end row -->
                                            <%}else{%>
                                                
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="offset-1 col-md-10">
                                                            <div class="p-20">
                                                                <div class="ex-page-content text-center">
                                                                    <h1 class="">Onaysız Hesap</h1>
                                                                    <h3 class="">API eklemek için hesabınızın onaylanması gerekiyor.</h3><br>
                                            
                                                                    <a class="btn btn-danger mb-5 waves-effect waves-light" href="/">Panele Dönmek için Tıklayın</a>
                                                                    
                                                                    <div id="uyari"></div>   
                                                                </div>
                                                            </div>
                                                        </div> <!-- end col -->
                                                        
                                                    </div> <!-- end row --> 
                                                </div>
                                                            
                                            <%}%>
                                        </div>
                                    </div>
                                </div> <!-- end col -->
                            </div> <!-- end row -->  
                        </div> <!-- end container -->
                    </div>

                <%}else{%>
                    <div class="wrapper">
                        <div class="container-fluid pt-5 pb-5">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="offset-1 col-md-10">
                                                    <div class="p-20">
                                                        <div class="ex-page-content text-center">
                                                            <h1 class="">404!</h1>
                                                            <h3 class="">Bu alana erişim yetkiniz yok</h3><br>
                                    
                                                            <a class="btn btn-danger mb-5 waves-effect waves-light" href="/">Panele Dönmek için Tıklayın</a>
                                                            
                                                            <div id="uyari"></div>   
                                                        </div>
                                                    </div>
                                                </div> <!-- end col -->
                                                
                                            </div> <!-- end row --> 
                                        </div>
                                    </div>
                                </div> <!-- end col -->
                            </div> <!-- end row -->   
                        </div>
                    </div>
                <%}%>
            
            <%}else if(status =='edit'){%>

                <%if(admin.role=='super'){%>
                    <div class="wrapper">
                        <div class="container-fluid">
            
                            <!-- Page-Title -->
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="page-title-box">
                                        <div class="btn-group pull-right">
                                            <ol class="breadcrumb hide-phone p-0 m-0">
                                                <li class="breadcrumb-item"><a href="#">Panel</a></li>
                                                <li class="breadcrumb-item"><a href="#">Ayarlar</a></li>
                                                <li class="breadcrumb-item active">API Ayarları</li>
                                            </ol>
                                        </div>
                                        <h4 class="page-title">Api Ekle </h4>
                                    </div>
                                </div>
                            </div>
                            <!-- end page title end breadcrumb -->
                        

                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <%if(admin.confirmation == true){%>
                                                
                                                <div class="row">
                                                    <div class="offset-1 col-md-10">
                                                        <div class="p-20">
                                                            
                                                            <h4 class="mt-0 header-title">API Bilgilerini Düzenle</h4>
                                                            
                                                            <form method="post" action="/api/edit?_method=PUT">
                                                                <div class="row">
        
                                                                    <div class="col-md-12">
                                                                        <label>API Durumu</label>
                                                                        <select name="status"class="form-control">
                                                                            <option value="<%= selectApi.status%>">
                                                                                <%if(selectApi.status == true){%>
                                                                                    Aktif
                                                                                <%}else{%>
                                                                                    Pasif
                                                                                <%}%>
                                                                            </option>

                                                                            <%if(selectApi.status == true){%>
                                                                                <option value="false">Pasif</option>
                                                                            <%}else{%>
                                                                                <option value="true">Aktif</option>
                                                                            <%}%>
                                                                            
                                                                            
                                                                        </select>
                                                                    </div>

                                                                    <div class="col-md-6">
                                                                        <div class="form-group mb-0">
                                                                            <label class="my-2 py-1">İsim</label>
                                                                            <input type="text" value="<%= selectApi.name %>" name="name"  class="form-control">
                                                                        </div>
                                                                    </div>

                                                                    <div class="col-md-6">
                                                                        <div class="form-group mb-0">
                                                                            <label class="my-2 py-1">E-Mail</label>
                                                                            <input type="email"  value="<%= selectApi.email %>" name="email"  class="form-control">
                                                                        </div>
                                                                    </div>
        
                                                                    
                                                                </div>

                                                                <input type="hidden" name="selectId" value="<%= selectApi._id %>">

                                                                <div style="text-align: center" class="form-group mb-0 mt-5">
                                                                    <div class="">
                                                                        <button type="submit" class="btn btn-primary waves-effect waves-light">
                                                                            Gönder
                                                                        </button>
                                                                        <button type="reset" class="btn btn-secondary waves-effect m-l-5">
                                                                            İptal
                                                                        </button>
                                                                    </div>
                                                                </div>
        
                                                            </form> 
                                                        
                                                        </div>
                                                    </div> <!-- end col -->
                                                    
                                                </div> <!-- end row -->
                                                
                                            <%}else{%>
                                                
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="offset-1 col-md-10">
                                                            <div class="p-20">
                                                                <div class="ex-page-content text-center">
                                                                    <h1 class="">Onaysız Hesap</h1>
                                                                    <h3 class="">API bilgisi eklemek için hesabınızın onaylanması gerekiyor.</h3><br>
                                            
                                                                    <a class="btn btn-danger mb-5 waves-effect waves-light" href="/">Panele Dönmek için Tıklayın</a>
                                                                    
                                                                    <div id="uyari"></div>   
                                                                </div>
                                                            </div>
                                                        </div> <!-- end col -->
                                                        
                                                    </div> <!-- end row --> 
                                                </div>
                                                            
                                            <%}%>
                                        </div>
                                    </div>
                                </div> <!-- end col -->
                            </div> <!-- end row -->  
                        </div> <!-- end container -->
                    </div>

                <%}else{%>
                    <div class="wrapper">
                        <div class="container-fluid pt-5 pb-5">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="offset-1 col-md-10">
                                                    <div class="p-20">
                                                        <div class="ex-page-content text-center">
                                                            <h1 class="">404!</h1>
                                                            <h3 class="">Bu alana erişim yetkiniz yok</h3><br>
                                    
                                                            <a class="btn btn-danger mb-5 waves-effect waves-light" href="/">Panele Dönmek için Tıklayın</a>
                                                            
                                                            <div id="uyari"></div>   
                                                        </div>
                                                    </div>
                                                </div> <!-- end col -->
                                                
                                            </div> <!-- end row --> 
                                        </div>
                                    </div>
                                </div> <!-- end col -->
                            </div> <!-- end row -->   
                        </div>
                    </div>
                <%}%>
   
            <%}else{%>

                <%if(admin.role=='super'){%>
                    <div class="wrapper">
                        <div class="container-fluid">

                            <!-- Page-Title -->
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="page-title-box">
                                        <div class="btn-group pull-right">
                                            <ol class="breadcrumb hide-phone p-0 m-0">
                                                <li class="breadcrumb-item"><a href="#">Panel</a></li>
                                                <li class="breadcrumb-item"><a href="#">Ayarlar</a></li>
                                                <li class="breadcrumb-item active">API'ler</li>
                                            </ol>
                                        </div>
                                        <h4 class="page-title">Oluşturulan API'ler  <a class="btn btn-success" href="/api?status=add" target="_blank" role="button">API Ekle</a></h4> 
                                       
                                       
                                    </div>
                                </div>
                            </div> 
                            <!-- end page title end breadcrumb -->  

                            <% if (flashMessages) { %>

                                <% if (flashMessages.success) { %>
    
                                    <div class="alert alert-success alert-dismissible">
                                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                                        <strong>Başarılı! </strong><%= flashMessages.success %>
                                    </div>
    
                                <% } else if (flashMessages.error) { %>
                                    <div class="alert alert-danger alert-dismissible">
                                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                                        <strong>Başarısız! </strong> <%= flashMessages.error %>
                                    </div>
                                <% } else if (flashMessages.info) { %>
                                    <div class="alert alert-info alert-dismissible">
                                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                                        <strong>Güncellendi! </strong> <%= flashMessages.info %>
                                    </div>
                                <% } else if (flashMessages.delete) { %>
                                    <div class="alert alert-info alert-dismissible">
                                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                                        <strong>Silindi! </strong> <%= flashMessages.delete %>
                                    </div>
                                <% } %>
    
                            <% } %>
                            
                            <!-- api liste alanı -->  
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">

                                            <table id="datatable-buttons" class="table table-striped table-bordered dt-responsive nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                                <thead>
                                                <tr>
                                                    <th>Oluşturma</th>
                                                    <th>İsim</th>
                                                    <th>Token</th>
                                                    <th>Aktiflik Durumu</th>
                                                    <th>Token Oluşturan</th>

                                                    <%if(admin.confirmation == true){%>
                                                        <th>İşlem</th>
                                                    <%}%>
                                                </tr>
                                                </thead>

                                                <tbody>
                                                <% for(let i=0; i< api.length; i++) {%>
                                                    <tr>
                                                        
                                                        <td><%= api[i].createdAt.toISOString().slice(0,10) %></td>
                                                        <td><%= api[i].name %></td>
                                                        <td><p id="token<%= i %>" style="display: inline"><%= api[i].apiToken %></p> <a href="#" style="display: inline" onclick="copy(`<%= i %>`)"><i class="mdi mdi-content-copy"></i></a></td>
                                                        <td>
                                                            <%if(api[i].status==true){%>
                                                                Aktif
                                                            <%}else{%>
                                                                Pasif
                                                            <%}%>
                                                        </td>
                                                        <td><%= api[i].admin.name %></td>

                                                        <%if(admin.confirmation == true){%>
                                                            <td>
                                                                <a href="/api/edit/<%= api[i]._id %>?status=edit">
                                                                    <button type="button" class="btn btn-lg btn-warning btn-sm "><i class="fas fa-user-edit"></i></button>
                                                                </a>
                                                                <a onclick="deleteAPI(`<%= api[i]._id %>`,`<%= api[i].name %>`)" >
                                                                    <button type="button" class="btn btn-lg btn-danger btn-sm "><i class="fas fa-user-times"></i></button>
                                                                </a>
                                                                <form style="display: inline" method="post" onsubmit="okAPI(`<%= api[i].name %>`,`<%= api[i].status %>`)" action="/api/ok/?_method=PUT">
                                                                    <input type="hidden" name="apiId" value="<%= api[i]._id %>">
                                                                    <button class="btn btn-lg btn-success btn-sm "><i class="fas fa-user-check"></i></button>
                                                                </form>
                                                            </td>
                                                        <%}%>

                                                    </tr>                                 
                                                <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div> <!-- end col -->
                            </div> <!-- end row -->

                            <!-- Page-Title -->
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="page-title-box">
                                        <h4 class="page-title">API Adresleri </h4> 
                                       
                                    </div>
                                </div>
                            </div> 

                            <!-- api adresleri -->  
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">

                                            <table id="datatable-buttons" class="table table-striped table-bordered dt-responsive nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                                <thead>
                                                <tr>
                                                    <th>Method</th>
                                                    <th>Kategori</th>
                                                    <th>API</th>
                                                </tr>
                                                </thead>

                                                <tbody>
                                                    <tr>
                                                        <td>GET</td>
                                                        <td>Borçlular</td>
                                                        <td><b><a href="/api/debts?api_key=api-key-giriniz" target="_blank">/debts</a></b></td>
                                                    </tr>    
                                                    <tr>
                                                        <td>GET</td>
                                                        <td>İlaçlar</td>
                                                        <td><b><a href="/api/medicine?api_key=api-key-giriniz" target="_blank">/medicines</a></b></td>
                                                    </tr>                                 
                                             
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div> <!-- end col -->
                            </div> <!-- end row -->

                            
                 
                        </div>    
                    </div>

                <%}else{%>
                    <div class="wrapper">
                        <div class="container-fluid pt-5 pb-5">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="offset-1 col-md-10">
                                                    <div class="p-20">
                                                        <div class="ex-page-content text-center">
                                                            <h1 class="">404!</h1>
                                                            <h3 class="">Bu alana erişim yetkiniz yok</h3><br>
                                    
                                                            <a class="btn btn-danger mb-5 waves-effect waves-light" href="/">Panele Dönmek için Tıklayın</a>
                                                            
                                                            <div id="uyari"></div>   
                                                        </div>
                                                    </div>
                                                </div> <!-- end col -->
                                                
                                            </div> <!-- end row --> 
                                        </div>
                                    </div>
                                </div> <!-- end col -->
                            </div> <!-- end row -->   
                        </div>
                    </div>
                <%}%>

            <%}%>

        <%}%>

   <!-- Footer -->
   <%- include('partials/_footer')%>
   <!-- End Footer -->

    <!-- sweet alert  init js -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.all.min.js"></script>

    <script>
    function Yonlendir(ID, adres, saniye) {
        if (saniye == 0) {
            window.location.href = adres;
        return;
        }
        document.getElementById(ID).innerHTML = saniye + " saniye sonra yönlendiriliyorsunuz.";
        saniye--;
        setTimeout(function() {
            Yonlendir(ID, adres, saniye);
        }, 1000);
    }
    
    function copy(id) {

        var copyText = document.getElementById("token"+id);  
       
        var input = document.createElement("textarea");
        //adding p tag text to textarea 
        input.value = copyText.textContent;
        document.body.appendChild(input);
        input.select();
        document.execCommand("Copy");
        // removing textarea after copy
        input.remove();
    }
   
    function deleteAPI(id,name){
            Swal.fire({
            title: `${name} API keyini silmek istediğinize emin misiniz ?`,
            icon: 'warning',
            showCancelButton: true,
            showDenyButton: true,
            confirmButtonColor: '#28A745',
            cancelButtonColor: '#6E7881',
            denyButtonColor: `#DC3545`,
            confirmButtonText: 'Evet',
            denyButtonText: `Hayır`,
            cancelButtonText: 'İptal',
            
            }).then((result) => {

                if (result.isConfirmed) {
                    Swal.fire(
                        "API Silindi!",
                        `${name} başarılı bir şekilde silindi..`,
                        "success",
                    ).then(() => {
                        window.location = `/api/${id}?_method=DELETE`;
                    })   
                
                }else if(result.isDenied) {
                    Swal.fire(
                        "API Silinmedi!",
                        `${name} isteğiniz üzerine silinmedi`,
                        "error",
                    );
                }

                
            });
        };

    function okAPI(name,status){
        
        if(status =='true'){
            Swal.fire(
            "API Zaten Aktif!",
            `${name} zaten aktif.`,
            "error",
            
            ).then(()=>{
                window.location = '/api';
            })

        }else{
            Swal.fire(
            "API Aktif!",
            `${name} aktif hale getirildi.`,
            "success",
            
            ).then((result) => {
                window.location = `/api`;

            });
            setTimeout(function() {
            window.location = `/api`;
            }, 3000);
        };
        }

    </script>

    <script>
        Yonlendir("uyari", "/", 10);
    </script>
    
    </body>
</html>







